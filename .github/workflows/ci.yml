name: Monitoring Prod CI

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  monitoring-prod:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      # .env 생성
      - name: Create .env
        run: |
          cat <<EOF > .env
          SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
          AWS_REGIONS=${{ secrets.AWS_REGIONS }}
          ECS_CLUSTER_NAME=${{ secrets.ECS_CLUSTER_NAME }}
          GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
          KAFKA_BROKER_1=${{ secrets.KAFKA_BROKER_1 }}
          EOF

      # docker-compose 문법 검증
      - name: Docker Compose config check
        run: docker compose config

      - name: Make entrypoint executable
        run: |
          find . -name "entrypoint.sh" -type f -exec chmod +x {} \;

      # 컨테이너 기동
      - name: Start monitoring stack
        run: docker compose up -d

      - name: Check container status
        run: docker compose ps

      - name: Wait for Alertmanager
        run: |
          for i in {1..20}; do
            if curl -sf http://localhost:9093/-/ready; then exit 0; fi
            sleep 3
          done
          docker compose logs alertmanager
          exit 1
      
      - name: Wait for Grafana
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:3000/api/health; then exit 0; fi
            sleep 3
          done
          docker compose logs grafana
          exit 1
      
      - name: Wait for Loki
        run: |
          for i in {1..20}; do
            if curl -sf http://localhost:3100/ready; then exit 0; fi
            sleep 3
          done
          docker compose logs loki
          exit 1
          
      - name: Wait for Prometheus
        run: |
          for i in {1..20}; do
            if curl -sf http://localhost:9090/-/ready; then
              echo "Prometheus ready"
              exit 0
            fi
            sleep 3
          done
          echo "Prometheus not ready"
          docker compose logs prometheus
          exit 1

      # Prometheus config 파싱 확인
      - name: Validate Prometheus config loaded
        run: |
          curl -sf http://localhost:9090/api/v1/status/config | jq .

      #6. 최종 안전벨트
      - name: Fail if any container exited
        run: |
          if docker compose ps | grep -E "Exit|Restarting"; then
            echo "Some containers are not healthy"
            docker compose ps
            exit 1
          fi
    
      # 종료
      - name: Shutdown
        if: always()
        run: docker compose down -v
