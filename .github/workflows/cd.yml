name: Monitoring Prod CD

on:
  push:
    branches: [ "test-cd" ]

jobs:
  deploy-monitoring-prod:
    if: >
      github.event.workflow_run.conclusion == 'success' 

    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH for Bastion
        run: |
          mkdir -p ~/.ssh

          echo "${{ secrets.BASTION_PEM }}" > ~/.ssh/bastion.pem
          chmod 400 ~/.ssh/bastion.pem

          ssh-keyscan -H ${{ secrets.BASTION_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via Bastion
        run: |
          ssh -i ~/.ssh/bastion.pem ec2-user@${{ secrets.BASTION_HOST }} << 'EOF'
set -e

echo "▶ SSH from Bastion to Monitoring EC2"
ssh -i ~/monitoring-ec2.pem ec2-user@10.0.2.114 << 'INNER'
set -e

cd /home/ec2-user/monitoring/Monitoring/prod

echo "▶ Create .env (overwrite)"
cat > .env << 'ENVEOF'
TZ=Asia/Seoul
SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}
AWS_REGIONS=${{ secrets.AWS_REGIONS }}
ECS_CLUSTER_NAME=${{ secrets.ECS_CLUSTER_NAME }}
GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
KAFKA_BROKER_1=${{ secrets.KAFKA_BROKER_1 }}
KAFKA_BROKER_2=${{ secrets.KAFKA_BROKER_2 }}
ENVEOF

echo "▶ Pull latest code"
git fetch origin
git checkout dev
git pull origin dev

echo "▶ Validate docker compose config"
docker compose config

echo "▶ Restart monitoring stack"
docker compose down
docker compose up -d

echo "▶ Container status"
docker compose ps

echo "✅ Monitoring Prod deployed successfully"
INNER
EOF
