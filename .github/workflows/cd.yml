name: Monitoring Prod CD

on:
  push:
    branches: [ "dev" ]

jobs:
  deploy-monitoring-prod:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # GitHub → Bastion 키 세팅
      - name: Setup SSH for Bastion
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.BASTION_SSH_KEY }}" > ~/.ssh/bastion.pem
          chmod 400 ~/.ssh/bastion.pem
          ssh-keyscan -H ${{ secrets.BASTION_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy via Bastion
        run: |
          ssh -i ~/.ssh/bastion.pem \
              ${{ secrets.BASTION_USER }}@${{ secrets.BASTION_HOST }} << 'EOF'
            set -e

            echo "➡️ SSH to Monitoring EC2 from Bastion"
            ssh -i ~/monitoring-ec2.pem ec2-user@${{ secrets.MONITORING_PRIVATE_IP }} << 'INNER'
              set -e

              cd /home/ec2-user/monitoring/Monitoring/prod
              
              echo "▶ Create .env (overwrite)"
              cat > .env << 'ENVEOF'
              TZ=Asia/Seoul

              # Slack / Alert
              SLACK_WEBHOOK_URL=${{ secrets.SLACK_WEBHOOK_URL }}

              # AWS / ECS
              AWS_REGIONS=${{ secrets.AWS_REGIONS }}
              ECS_CLUSTER_NAME=${{ secrets.ECS_CLUSTER_NAME }}

              # Grafana
              GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}

              # Kafka
              KAFKA_BROKER_1=${{ secrets.KAFKA_BROKER_1 }}
              KAFKA_BROKER_2=${{ secrets.KAFKA_BROKER_2 }}
              ENVEOF

              echo "Pull latest code"
              git pull origin dev

              echo "Stop monitoring stack"
              docker compose down

              echo "Start monitoring stack"
              docker compose up -d

              echo "✅ Monitoring deployed successfully"
            INNER
          EOF
